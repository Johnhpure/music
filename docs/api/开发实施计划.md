# AIéŸ³ä¹å¹³å° - å¼€å‘å®æ–½è®¡åˆ’

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: AIéŸ³ä¹åˆ›ä½œå¹³å° - APIç»Ÿä¸€æ¶æ„
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2024-01-20
- **è®¡åˆ’å‘¨æœŸ**: 4å‘¨ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 ç›®æ ‡

æ„å»ºç»Ÿä¸€çš„APIæ¶æ„ï¼Œä½¿åç«¯æœåŠ¡èƒ½å¤ŸåŒæ—¶æ”¯æŒï¼š
- âœ… å¾®ä¿¡å°ç¨‹åºç«¯ï¼ˆç”¨æˆ·åŠŸèƒ½ï¼‰
- âœ… ç®¡ç†åå°ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
- âœ… æ¸…æ™°çš„æƒé™æ§åˆ¶
- âœ… é«˜æ€§èƒ½ã€å¯æ‰©å±•

### 1.2 å®æ–½ç­–ç•¥

é‡‡ç”¨**æ¸è¿›å¼é‡æ„**ï¼Œç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼š
1. å…ˆæ„å»ºæƒé™ç³»ç»Ÿå’ŒåŸºç¡€è®¾æ–½
2. é€æ­¥è¿ç§»ç°æœ‰æ¥å£åˆ°æ–°æ¶æ„
3. å¼€å‘ç®¡ç†åå°ä¸“ç”¨æ¥å£
4. å‰ç«¯å¯¹æ¥å’Œæµ‹è¯•
5. ä¼˜åŒ–å’Œä¸Šçº¿

---

## 2. é˜¶æ®µåˆ’åˆ†

### Phase 1: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰
**ç›®æ ‡**: å»ºç«‹æƒé™ç³»ç»Ÿã€ç»Ÿä¸€å“åº”æ ¼å¼ã€æ—¥å¿—ç³»ç»Ÿ

### Phase 2: APIè·¯ç”±é‡æ„ï¼ˆç¬¬2å‘¨ï¼‰
**ç›®æ ‡**: ç°æœ‰æ¥å£è¿ç§»åˆ°åˆ†å±‚è·¯ç”±ç»“æ„

### Phase 3: ç®¡ç†æ¥å£å¼€å‘ï¼ˆç¬¬3å‘¨ï¼‰
**ç›®æ ‡**: å¼€å‘ç®¡ç†åå°ä¸“ç”¨çš„CRUDã€ç»Ÿè®¡ã€æ‰¹é‡æ“ä½œæ¥å£

### Phase 4: å‰ç«¯å¯¹æ¥ä¸æµ‹è¯•ï¼ˆç¬¬4å‘¨ï¼‰
**ç›®æ ‡**: å°ç¨‹åºAPIè°ƒæ•´ã€ç®¡ç†åå°å¯¹æ¥ã€å…¨é¢æµ‹è¯•

---

## 3. è¯¦ç»†ä»»åŠ¡åˆ†è§£

### ğŸ“… Phase 1: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰

#### ä»»åŠ¡1.1: æƒé™ç³»ç»Ÿ [2å¤©]

**1.1.1 åˆ›å»ºè§’è‰²æšä¸¾å’Œè£…é¥°å™¨**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/common/enums/user-role.enum.ts
- backend/src/common/decorators/roles.decorator.ts
- backend/src/common/decorators/public.decorator.ts
```

```typescript
// user-role.enum.ts
export enum UserRole {
  USER = 'user',
  ADMIN = 'admin',
  SUPER_ADMIN = 'super_admin'
}

// roles.decorator.ts
export const Roles = (...roles: UserRole[]) => SetMetadata('roles', roles);

// public.decorator.ts
export const Public = () => SetMetadata('isPublic', true);
```

**1.1.2 åˆ›å»ºAdminGuard**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/common/guards/admin.guard.ts
```

```typescript
@Injectable()
export class AdminGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    
    if (!user || user.role !== UserRole.ADMIN) {
      throw new ForbiddenException('éœ€è¦ç®¡ç†å‘˜æƒé™');
    }
    
    return true;
  }
}
```

**1.1.3 ä¿®æ”¹JWTç­–ç•¥**
```bash
ä¿®æ”¹æ–‡ä»¶:
- backend/src/modules/auth/strategies/jwt.strategy.ts
```

åœ¨payloadä¸­æ·»åŠ roleå­—æ®µï¼Œvalidateæ–¹æ³•è¿”å›åŒ…å«roleçš„ç”¨æˆ·å¯¹è±¡ã€‚

**1.1.4 æ•°æ®åº“è¿ç§»**
```sql
-- backend/src/database/migrations/12-add-user-role.sql
ALTER TABLE `t_users` 
ADD COLUMN `role` VARCHAR(20) DEFAULT 'user' COMMENT 'è§’è‰²ï¼šuser/admin' AFTER `is_admin`,
ADD INDEX `idx_role` (`role`);

-- å°†ç°æœ‰ç®¡ç†å‘˜æ ‡è®°ä¸ºadminè§’è‰²
UPDATE `t_users` SET `role` = 'admin' WHERE `is_admin` = 1;
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] AdminGuardæ­£ç¡®æ‹¦æˆªéç®¡ç†å‘˜è¯·æ±‚
- [ ] JWT tokenåŒ…å«roleä¿¡æ¯
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸæ‰§è¡Œ

---

#### ä»»åŠ¡1.2: ç»Ÿä¸€å“åº”æ ¼å¼ [1å¤©]

**1.2.1 åˆ›å»ºå“åº”æ‹¦æˆªå™¨**
```bash
ä¿®æ”¹æ–‡ä»¶:
- backend/src/common/interceptors/transform.interceptor.ts
```

```typescript
export class TransformInterceptor<T> implements NestInterceptor<T, Response<T>> {
  intercept(context: ExecutionContext, next: CallHandler): Observable<Response<T>> {
    return next.handle().pipe(
      map(data => ({
        code: 200,
        message: 'success',
        data,
        timestamp: Date.now()
      }))
    );
  }
}
```

**1.2.2 ç»Ÿä¸€å¼‚å¸¸è¿‡æ»¤å™¨**
```bash
ä¿®æ”¹æ–‡ä»¶:
- backend/src/common/filters/http-exception.filter.ts
```

ç¡®ä¿æ‰€æœ‰é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æˆåŠŸå“åº”æ ¼å¼ç»Ÿä¸€
- [ ] æ‰€æœ‰é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€
- [ ] åŒ…å«æ—¶é—´æˆ³å­—æ®µ

---

#### ä»»åŠ¡1.3: æ—¥å¿—å’Œå®¡è®¡ç³»ç»Ÿ [2å¤©]

**1.3.1 åˆ›å»ºç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨**
```sql
-- backend/src/database/migrations/13-create-admin-logs.sql
CREATE TABLE IF NOT EXISTS `t_admin_logs` (
  `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  `admin_id` INT UNSIGNED NOT NULL COMMENT 'ç®¡ç†å‘˜ID',
  `action` VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  `resource` VARCHAR(100) NOT NULL COMMENT 'æ“ä½œèµ„æº',
  `resource_id` VARCHAR(50) NULL COMMENT 'èµ„æºID',
  `details` JSON NULL COMMENT 'æ“ä½œè¯¦æƒ…',
  `ip_address` VARCHAR(50) NULL COMMENT 'IPåœ°å€',
  `user_agent` VARCHAR(500) NULL COMMENT 'User Agent',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX `idx_admin_created` (`admin_id`, `created_at` DESC),
  INDEX `idx_action` (`action`),
  INDEX `idx_resource` (`resource`, `resource_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨';
```

**1.3.2 åˆ›å»ºå®¡è®¡æœåŠ¡**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/common/services/audit.service.ts
- backend/src/common/entities/admin-log.entity.ts
```

```typescript
@Injectable()
export class AuditService {
  async log(logData: CreateAdminLogDto): Promise<void> {
    await this.adminLogRepository.save(logData);
  }
}
```

**1.3.3 åˆ›å»ºå®¡è®¡è£…é¥°å™¨**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/common/decorators/audit.decorator.ts
```

```typescript
export const Audit = (action: string, resource: string) => 
  SetMetadata('audit', { action, resource });
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç®¡ç†å‘˜æ“ä½œè‡ªåŠ¨è®°å½•åˆ°æ•°æ®åº“
- [ ] åŒ…å«å®Œæ•´çš„æ“ä½œä¿¡æ¯ï¼ˆæ—¶é—´ã€IPã€è¯¦æƒ…ï¼‰
- [ ] å¯æŸ¥è¯¢å†å²æ“ä½œè®°å½•

---

### ğŸ“… Phase 2: APIè·¯ç”±é‡æ„ï¼ˆç¬¬2å‘¨ï¼‰

#### ä»»åŠ¡2.1: Banneræ¨¡å—é‡æ„ [1å¤©]

**2.1.1 åˆ›å»ºä¸‰å±‚Controller**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/banner/public-banner.controller.ts
- backend/src/modules/banner/admin-banner.controller.ts
```

```typescript
// public-banner.controller.ts
@Controller('api/public/banner')
export class PublicBannerController {
  @Public()
  @Get('list')
  async getActiveBanners() {
    return this.bannerService.findActive();
  }
}

// admin-banner.controller.ts
@Controller('api/admin/banner')
@UseGuards(JwtAuthGuard, AdminGuard)
export class AdminBannerController {
  @Get('list')
  @Audit('BANNER_LIST', 'banner')
  async getAllBanners(@Query() query: QueryBannerDto) {
    return this.bannerService.findAll(query);
  }
  
  @Post()
  @Audit('BANNER_CREATE', 'banner')
  async createBanner(@Body() dto: CreateBannerDto, @User() user) {
    return this.bannerService.create(dto, user.id);
  }
  
  @Patch(':id')
  @Audit('BANNER_UPDATE', 'banner')
  async updateBanner(@Param('id') id: number, @Body() dto: UpdateBannerDto) {
    return this.bannerService.update(id, dto);
  }
  
  @Delete(':id')
  @Audit('BANNER_DELETE', 'banner')
  async deleteBanner(@Param('id') id: number) {
    return this.bannerService.softDelete(id);
  }
}
```

**2.1.2 æ‰©å±•Serviceæ–¹æ³•**
```typescript
// banner.service.ts
async findActive(): Promise<Banner[]> {
  return this.bannerRepository.find({
    where: { isActive: true, deletedAt: IsNull() },
    order: { sortOrder: 'ASC' },
    select: ['id', 'title', 'imageUrl', 'linkUrl']
  });
}

async findAll(query: QueryBannerDto): Promise<PaginatedResult<Banner>> {
  const { page = 1, pageSize = 10, status } = query;
  const [items, total] = await this.bannerRepository.findAndCount({
    where: { 
      ...(status && { isActive: status === 'active' }),
      deletedAt: IsNull()
    },
    order: { sortOrder: 'ASC' },
    skip: (page - 1) * pageSize,
    take: pageSize
  });
  
  return {
    items,
    total,
    page,
    pageSize,
    totalPages: Math.ceil(total / pageSize)
  };
}

async softDelete(id: number): Promise<void> {
  await this.bannerRepository.update(id, { deletedAt: new Date() });
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å…¬å¼€æ¥å£è¿”å›å¯ç”¨çš„banner
- [ ] ç®¡ç†æ¥å£æ”¯æŒCRUDæ“ä½œ
- [ ] æ”¯æŒåˆ†é¡µå’Œç­›é€‰
- [ ] æ“ä½œè®°å½•åˆ°å®¡è®¡æ—¥å¿—

---

#### ä»»åŠ¡2.2: æç¤ºè¯æ¨¡æ¿æ¨¡å—é‡æ„ [1å¤©]

ç±»ä¼¼Banneræ¨¡å—ï¼Œåˆ›å»ºï¼š
```bash
- backend/src/modules/prompt-template/public-prompt-template.controller.ts
- backend/src/modules/prompt-template/admin-prompt-template.controller.ts
```

**æ–°å¢åŠŸèƒ½**:
- æ‰¹é‡å¯ç”¨/ç¦ç”¨
- æ‹–æ‹½æ’åº
- ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢

**éªŒæ”¶æ ‡å‡†**:
- [ ] å…¬å¼€æ¥å£è¿”å›å¯ç”¨çš„æ¨¡æ¿
- [ ] ç®¡ç†æ¥å£æ”¯æŒå®Œæ•´CRUD
- [ ] æ”¯æŒæ‰¹é‡æ“ä½œ
- [ ] ç»Ÿè®¡æ•°æ®å‡†ç¡®

---

#### ä»»åŠ¡2.3: çƒ­é—¨æ¨èæ¨¡å—é‡æ„ [1å¤©]

```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/hot-recommendation/public-hot-recommendation.controller.ts
- backend/src/modules/hot-recommendation/admin-hot-recommendation.controller.ts
```

**æ–°å¢åŠŸèƒ½**:
- æ¨èåˆ†ç±»ç®¡ç†
- æ’­æ”¾ç»Ÿè®¡æŸ¥è¯¢
- çƒ­åº¦æ’è¡Œæ¦œ

**éªŒæ”¶æ ‡å‡†**:
- [ ] å°ç¨‹åºå¯ä»¥è·å–æ¨èéŸ³ä¹
- [ ] ç®¡ç†åå°å¯ä»¥ç®¡ç†æ¨èå†…å®¹
- [ ] æ’­æ”¾ç»Ÿè®¡æ•°æ®å‡†ç¡®

---

#### ä»»åŠ¡2.4: ç”¨æˆ·æ¥å£é‡æ„ [2å¤©]

**2.4.1 åˆ›å»ºç”¨æˆ·Controller**
```bash
ä¿®æ”¹æ–‡ä»¶:
- backend/src/modules/user/user.controller.ts (æ”¹ä¸ºç”¨æˆ·ç«¯)
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/user/admin-user.controller.ts
```

**ç”¨æˆ·ç«¯æ¥å£** (`/api/user/profile`)
- GET /profile - è·å–ä¸ªäººä¿¡æ¯
- PATCH /profile - æ›´æ–°ä¸ªäººä¿¡æ¯
- POST /checkin - æ¯æ—¥ç­¾åˆ°
- GET /stats - ä¸ªäººç»Ÿè®¡

**ç®¡ç†ç«¯æ¥å£** (`/api/admin/users`)
- GET /list - ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
- GET /:id - ç”¨æˆ·è¯¦æƒ…
- POST /:id/ban - å°ç¦ç”¨æˆ·
- POST /:id/unban - è§£å°ç”¨æˆ·
- PATCH /:id/credits - è°ƒæ•´ç”¨æˆ·ç§¯åˆ†

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„ä¿¡æ¯
- [ ] ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·
- [ ] æ•æ„Ÿä¿¡æ¯ï¼ˆopenidï¼‰ä¸æš´éœ²ç»™ç®¡ç†å‘˜

---

### ğŸ“… Phase 3: ç®¡ç†æ¥å£å¼€å‘ï¼ˆç¬¬3å‘¨ï¼‰

#### ä»»åŠ¡3.1: æ•°æ®ç»Ÿè®¡æ¥å£ [3å¤©]

**3.1.1 åˆ›å»ºç»Ÿè®¡æ¨¡å—**
```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/statistics/statistics.module.ts
- backend/src/modules/statistics/statistics.controller.ts
- backend/src/modules/statistics/statistics.service.ts
```

**æ¥å£åˆ—è¡¨**:

```typescript
// /api/admin/statistics

// ä»ªè¡¨æ¿æ¦‚è§ˆ
@Get('dashboard')
async getDashboard(): Promise<DashboardStats> {
  return {
    users: {
      total: number,
      today: number,
      active: number
    },
    works: {
      total: number,
      today: number,
      public: number
    },
    credits: {
      consumed: number,
      recharged: number,
      balance: number
    },
    revenue: {
      today: number,
      week: number,
      month: number
    }
  };
}

// ç”¨æˆ·å¢é•¿è¶‹åŠ¿
@Get('users/growth')
async getUserGrowth(@Query() query: DateRangeDto): Promise<ChartData> {
  // è¿”å›æ—¶é—´åºåˆ—æ•°æ®
}

// ä½œå“ç»Ÿè®¡
@Get('works/stats')
async getWorksStats(@Query() query: DateRangeDto): Promise<WorksStats> {
  // æŒ‰é£æ ¼ã€æ—¶é•¿ç­‰ç»´åº¦ç»Ÿè®¡
}

// æ”¶å…¥ç»Ÿè®¡
@Get('revenue/trend')
async getRevenueTrend(@Query() query: DateRangeDto): Promise<ChartData> {
  // æ”¶å…¥è¶‹åŠ¿å›¾æ•°æ®
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä»ªè¡¨æ¿æ•°æ®å‡†ç¡®
- [ ] å›¾è¡¨æ•°æ®æ ¼å¼æ­£ç¡®
- [ ] æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
- [ ] æŸ¥è¯¢æ€§èƒ½è‰¯å¥½ï¼ˆ<500msï¼‰

---

#### ä»»åŠ¡3.2: è®¢å•ç®¡ç†æ¥å£ [2å¤©]

```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/payment/admin-payment.controller.ts
```

**æ¥å£åˆ—è¡¨**:
```typescript
// /api/admin/orders

// è®¢å•åˆ—è¡¨
@Get('list')
async getOrders(@Query() query: QueryOrderDto): Promise<PaginatedResult<Order>> {
  // æ”¯æŒæŒ‰çŠ¶æ€ã€ç”¨æˆ·ã€æ—¥æœŸç­›é€‰
}

// è®¢å•è¯¦æƒ…
@Get(':id')
async getOrderDetail(@Param('id') id: string): Promise<Order> {
  // åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€å¥—é¤ä¿¡æ¯
}

// è®¢å•ç»Ÿè®¡
@Get('statistics')
async getOrderStatistics(@Query() query: DateRangeDto): Promise<OrderStats> {
  // è®¢å•é‡ã€é‡‘é¢ç»Ÿè®¡
}

// é€€æ¬¾æ“ä½œ
@Post(':id/refund')
async refundOrder(@Param('id') id: string, @Body() dto: RefundDto): Promise<void> {
  // æ‰§è¡Œé€€æ¬¾é€»è¾‘
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯æŸ¥çœ‹æ‰€æœ‰è®¢å•
- [ ] æ”¯æŒå¤šç»´åº¦ç­›é€‰
- [ ] é€€æ¬¾æµç¨‹æ­£ç¡®
- [ ] æ“ä½œè®°å½•åˆ°å®¡è®¡æ—¥å¿—

---

#### ä»»åŠ¡3.3: ç³»ç»Ÿé…ç½®æ¥å£ [2å¤©]

```bash
åˆ›å»ºæ–‡ä»¶:
- backend/src/modules/system/system.module.ts
- backend/src/modules/system/admin-system.controller.ts
- backend/src/modules/system/system.service.ts
```

**æ¥å£åˆ—è¡¨**:
```typescript
// /api/admin/system

// è·å–é…ç½®åˆ—è¡¨
@Get('configs')
async getConfigs(): Promise<SystemConfig[]> {
  // è¿”å›å¯é…ç½®é¡¹
}

// æ›´æ–°é…ç½®
@Patch('configs/:key')
async updateConfig(@Param('key') key: string, @Body() dto: UpdateConfigDto): Promise<void> {
  // æ›´æ–°é…ç½®é¡¹
}

// è·å–æ“ä½œæ—¥å¿—
@Get('logs')
async getLogs(@Query() query: QueryLogDto): Promise<PaginatedResult<AdminLog>> {
  // è¿”å›ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
}

// ç³»ç»Ÿå¥åº·æ£€æŸ¥
@Get('health')
async getHealth(): Promise<HealthStatus> {
  return {
    database: 'ok',
    redis: 'ok',
    storage: 'ok',
    api: 'ok'
  };
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯åŠ¨æ€ä¿®æ”¹ç³»ç»Ÿé…ç½®
- [ ] æ“ä½œæ—¥å¿—å®Œæ•´å¯æŸ¥
- [ ] å¥åº·æ£€æŸ¥å‡†ç¡®

---

### ğŸ“… Phase 4: å‰ç«¯å¯¹æ¥ä¸æµ‹è¯•ï¼ˆç¬¬4å‘¨ï¼‰

#### ä»»åŠ¡4.1: å°ç¨‹åºAPIè°ƒæ•´ [1å¤©]

**4.1.1 æ›´æ–°APIè·¯å¾„**
```javascript
// miniprogram/api/api.js

// æ—§è·¯å¾„: /banner/list
// æ–°è·¯å¾„: /api/public/banner/list

export default {
  // å…¬å¼€æ¥å£
  getBanners() {
    return minRequest.get('/api/public/banner/list');
  },
  
  getPromptTemplates(category) {
    return minRequest.get('/api/public/prompt-template/list', { category });
  },
  
  getHotRecommendations(params) {
    return minRequest.get('/api/public/hot-recommendation/list', params);
  },
  
  // ç”¨æˆ·æ¥å£
  getUserProfile() {
    return minRequest.get('/api/user/profile');
  },
  
  createMusicTask(params) {
    return minRequest.post('/api/user/music/generate', params);
  },
  
  // ... å…¶ä»–æ¥å£
};
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æ¥å£è·¯å¾„æ›´æ–°
- [ ] å°ç¨‹åºåŠŸèƒ½æ­£å¸¸
- [ ] æ— æŠ¥é”™æˆ–å¼‚å¸¸

---

#### ä»»åŠ¡4.2: ç®¡ç†åå°APIé›†æˆ [2å¤©]

**4.2.1 åˆ›å»ºAPIæœåŠ¡**
```typescript
// admin/src/api/index.ts

import axios from 'axios';

const http = axios.create({
  baseURL: 'http://192.168.1.118:3000',
  timeout: 30000
});

// è¯·æ±‚æ‹¦æˆªå™¨
http.interceptors.request.use(config => {
  const token = localStorage.getItem('admin_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(
  response => response.data.data,
  error => {
    if (error.response?.status === 401) {
      // è·³è½¬ç™»å½•
      router.push('/login');
    }
    return Promise.reject(error);
  }
);

export const adminApi = {
  // è®¤è¯
  auth: {
    login: (data: LoginDto) => 
      http.post('/api/auth/admin-login', data),
    
    logout: () => 
      http.post('/api/auth/logout'),
  },
  
  // Bannerç®¡ç†
  banner: {
    list: (params?: QueryParams) => 
      http.get('/api/admin/banner/list', { params }),
    
    create: (data: CreateBannerDto) => 
      http.post('/api/admin/banner', data),
    
    update: (id: number, data: UpdateBannerDto) => 
      http.patch(`/api/admin/banner/${id}`, data),
    
    delete: (id: number) => 
      http.delete(`/api/admin/banner/${id}`),
  },
  
  // ç”¨æˆ·ç®¡ç†
  users: {
    list: (params?: QueryParams) => 
      http.get('/api/admin/users/list', { params }),
    
    detail: (id: number) => 
      http.get(`/api/admin/users/${id}`),
    
    ban: (id: number) => 
      http.post(`/api/admin/users/${id}/ban`),
    
    unban: (id: number) => 
      http.post(`/api/admin/users/${id}/unban`),
  },
  
  // æ•°æ®ç»Ÿè®¡
  statistics: {
    dashboard: () => 
      http.get('/api/admin/statistics/dashboard'),
    
    userGrowth: (params: DateRangeParams) => 
      http.get('/api/admin/statistics/users/growth', { params }),
    
    revenueTrend: (params: DateRangeParams) => 
      http.get('/api/admin/statistics/revenue/trend', { params }),
  },
  
  // ç³»ç»Ÿç®¡ç†
  system: {
    configs: () => 
      http.get('/api/admin/system/configs'),
    
    updateConfig: (key: string, value: any) => 
      http.patch(`/api/admin/system/configs/${key}`, { value }),
    
    logs: (params?: QueryParams) => 
      http.get('/api/admin/system/logs', { params }),
    
    health: () => 
      http.get('/api/admin/system/health'),
  }
};
```

**4.2.2 æ›´æ–°ç®¡ç†åå°é¡µé¢**
```bash
æ›´æ–°æ–‡ä»¶:
- admin/src/views/Content/BannerManagement.vue
- admin/src/views/Content/PromptTemplateManagement.vue
- admin/src/views/Content/RecommendationManagement.vue
- admin/src/views/Users/UserManagement.vue
- admin/src/views/Dashboard/Dashboard.vue
```

å°†ç°æœ‰çš„mockæ•°æ®æ›¿æ¢ä¸ºçœŸå®APIè°ƒç”¨ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰é¡µé¢æ•°æ®æ¥è‡ªçœŸå®API
- [ ] CRUDæ“ä½œæ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] LoadingçŠ¶æ€æ­£ç¡®æ˜¾ç¤º

---

#### ä»»åŠ¡4.3: å…¨é¢æµ‹è¯• [2å¤©]

**4.3.1 åŠŸèƒ½æµ‹è¯•æ¸…å•**

**å°ç¨‹åºç«¯æµ‹è¯•**:
- [ ] é¦–é¡µbanneræ­£å¸¸æ˜¾ç¤º
- [ ] çƒ­é—¨æ¨èæ­£å¸¸åŠ è½½
- [ ] æç¤ºè¯æ¨¡æ¿æ­£å¸¸ä½¿ç”¨
- [ ] éŸ³ä¹ç”ŸæˆåŠŸèƒ½æ­£å¸¸
- [ ] æ­Œè¯ç”ŸæˆåŠŸèƒ½æ­£å¸¸
- [ ] ä¸ªäººä¸­å¿ƒä¿¡æ¯æ­£ç¡®
- [ ] ç§¯åˆ†å……å€¼æµç¨‹æ­£å¸¸
- [ ] ä½œå“ç®¡ç†åŠŸèƒ½æ­£å¸¸

**ç®¡ç†åå°æµ‹è¯•**:
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ä»ªè¡¨æ¿æ•°æ®å‡†ç¡®
- [ ] Bannerç®¡ç†CRUDæ­£å¸¸
- [ ] æç¤ºè¯ç®¡ç†CRUDæ­£å¸¸
- [ ] æ¨èç®¡ç†CRUDæ­£å¸¸
- [ ] ç”¨æˆ·ç®¡ç†åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®ç»Ÿè®¡å›¾è¡¨æ­£ç¡®
- [ ] æ“ä½œæ—¥å¿—å®Œæ•´è®°å½•
- [ ] ç³»ç»Ÿé…ç½®åŠŸèƒ½æ­£å¸¸

**4.3.2 æƒé™æµ‹è¯•**
- [ ] æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†æ¥å£
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç®¡ç†æ¥å£
- [ ] Tokenè¿‡æœŸæ­£ç¡®å¤„ç†
- [ ] æœªç™»å½•é‡å®šå‘æ­£ç¡®

**4.3.3 æ€§èƒ½æµ‹è¯•**
- [ ] åˆ—è¡¨æ¥å£å“åº”æ—¶é—´ < 200ms
- [ ] ç»Ÿè®¡æ¥å£å“åº”æ—¶é—´ < 500ms
- [ ] å¹¶å‘100ç”¨æˆ·æ— å¼‚å¸¸

**4.3.4 å®‰å…¨æµ‹è¯•**
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] XSSæ”»å‡»é˜²æŠ¤
- [ ] CSRFé˜²æŠ¤
- [ ] æ•æ„Ÿä¿¡æ¯è„±æ•

---

## 4. é£é™©ç®¡ç†

### 4.1 æ½œåœ¨é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| ç°æœ‰åŠŸèƒ½å—å½±å“ | é«˜ | ä¸­ | æ¸è¿›å¼é‡æ„ï¼Œå……åˆ†æµ‹è¯• |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ä½ | æ·»åŠ ç¼“å­˜å’Œç´¢å¼• |
| æ•°æ®è¿ç§»å¤±è´¥ | é«˜ | ä½ | å¤‡ä»½æ•°æ®ï¼Œå¯å›æ»š |
| å‰ç«¯å¯¹æ¥é—®é¢˜ | ä¸­ | ä¸­ | æå‰å¯¹é½æ¥å£æ–‡æ¡£ |

### 4.2 å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **ä»£ç å›æ»š**: æ¢å¤åˆ°é‡æ„å‰çš„Gitæäº¤
   ```bash
   git revert <commit-hash>
   ```

2. **æ•°æ®åº“å›æ»š**: æ‰§è¡Œå›æ»šè„šæœ¬
   ```sql
   -- å¦‚æœæ·»åŠ äº†æ–°å­—æ®µï¼Œæ‰§è¡ŒDROP COLUMN
   -- å¦‚æœä¿®æ”¹äº†æ•°æ®ï¼Œä»å¤‡ä»½æ¢å¤
   ```

3. **ç¼“å­˜æ¸…ç†**:
   ```bash
   redis-cli FLUSHALL
   ```

4. **æœåŠ¡é‡å¯**:
   ```bash
   pm2 restart backend
   ```

---

## 5. è´¨é‡ä¿éšœ

### 5.1 ä»£ç è§„èŒƒ

- éµå¾ªESLintè§„åˆ™
- æ‰€æœ‰Controlleræ–¹æ³•æ·»åŠ æ³¨é‡Š
- å¤æ‚é€»è¾‘æå–ä¸ºServiceæ–¹æ³•
- ä½¿ç”¨TypeScriptä¸¥æ ¼æ¨¡å¼

### 5.2 æµ‹è¯•è¦†ç›–

- **å•å…ƒæµ‹è¯•**: æ ¸å¿ƒServiceæ–¹æ³•
- **é›†æˆæµ‹è¯•**: APIæ¥å£ç«¯åˆ°ç«¯æµ‹è¯•
- **E2Eæµ‹è¯•**: å…³é”®ä¸šåŠ¡æµç¨‹

```bash
# è¿è¡Œæµ‹è¯•
npm run test

# æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
npm run test:cov

# ç›®æ ‡ï¼šè¦†ç›–ç‡ > 60%
```

### 5.3 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| APIå“åº”æ—¶é—´ï¼ˆP95ï¼‰ | < 500ms |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms |
| å¹¶å‘ç”¨æˆ· | > 100 |
| é”™è¯¯ç‡ | < 0.1% |

---

## 6. éƒ¨ç½²è®¡åˆ’

### 6.1 éƒ¨ç½²ç¯å¢ƒ

- **å¼€å‘ç¯å¢ƒ**: æœ¬åœ°å¼€å‘å’Œæµ‹è¯•
- **æµ‹è¯•ç¯å¢ƒ**: åŠŸèƒ½æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
- **ç”Ÿäº§ç¯å¢ƒ**: æ­£å¼ä¸Šçº¿

### 6.2 éƒ¨ç½²æ­¥éª¤

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p music_platform > backup_$(date +%Y%m%d).sql

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. å®‰è£…ä¾èµ–
cd backend && npm install

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
npm run migration:run

# 5. æ„å»ºé¡¹ç›®
npm run build

# 6. é‡å¯æœåŠ¡
pm2 restart backend

# 7. éªŒè¯éƒ¨ç½²
curl http://localhost:3000/api/health
```

### 6.3 ç›‘æ§

- **æ—¥å¿—ç›‘æ§**: ä½¿ç”¨PM2æŸ¥çœ‹æ—¥å¿—
  ```bash
  pm2 logs backend
  ```

- **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨PM2 Plusæˆ–è‡ªå»ºç›‘æ§
  ```bash
  pm2 plus
  ```

- **é”™è¯¯å‘Šè­¦**: é…ç½®é”™è¯¯é‚®ä»¶é€šçŸ¥

---

## 7. æ–‡æ¡£ä¸åŸ¹è®­

### 7.1 éœ€è¦æ›´æ–°çš„æ–‡æ¡£

- [ ] APIæ¥å£æ–‡æ¡£ï¼ˆSwaggerï¼‰
- [ ] ç®¡ç†åå°ä½¿ç”¨æ‰‹å†Œ
- [ ] æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- [ ] éƒ¨ç½²è¿ç»´æ‰‹å†Œ

### 7.2 åŸ¹è®­è®¡åˆ’

**ç®¡ç†å‘˜åŸ¹è®­**:
- ç®¡ç†åå°åŠŸèƒ½ä»‹ç»
- å¸¸ç”¨æ“ä½œæ¼”ç¤º
- å¼‚å¸¸å¤„ç†æŒ‡å—

**å¼€å‘å›¢é˜ŸåŸ¹è®­**:
- æ–°æ¶æ„è®¾è®¡è®²è§£
- ä»£ç è§„èŒƒè¯´æ˜
- å¸¸è§é—®é¢˜è§£ç­”

---

## 8. é‡Œç¨‹ç¢‘ä¸éªŒæ”¶

### 8.1 é‡Œç¨‹ç¢‘

| é˜¶æ®µ | æ—¶é—´èŠ‚ç‚¹ | å…³é”®äº§å‡º |
|------|----------|----------|
| Phase 1 | ç¬¬1å‘¨ç»“æŸ | æƒé™ç³»ç»Ÿã€æ—¥å¿—ç³»ç»Ÿ |
| Phase 2 | ç¬¬2å‘¨ç»“æŸ | APIè·¯ç”±é‡æ„å®Œæˆ |
| Phase 3 | ç¬¬3å‘¨ç»“æŸ | ç®¡ç†æ¥å£å¼€å‘å®Œæˆ |
| Phase 4 | ç¬¬4å‘¨ç»“æŸ | å…¨é¢æµ‹è¯•é€šè¿‡ï¼Œä¸Šçº¿ |

### 8.2 æœ€ç»ˆéªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:
- [ ] å°ç¨‹åºåŠŸèƒ½å®Œæ•´å¯ç”¨
- [ ] ç®¡ç†åå°æ‰€æœ‰æ¨¡å—æ­£å¸¸
- [ ] æƒé™æ§åˆ¶æ­£ç¡®æ— è¯¯

**æ€§èƒ½éªŒæ”¶**:
- [ ] APIå“åº”æ—¶é—´è¾¾æ ‡
- [ ] å¹¶å‘å‹åŠ›æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å®Œæˆ

**å®‰å…¨éªŒæ”¶**:
- [ ] å®‰å…¨æµ‹è¯•æ— é«˜å±æ¼æ´
- [ ] æ“ä½œå®¡è®¡å®Œæ•´
- [ ] æ•æ„Ÿä¿¡æ¯ä¿æŠ¤åˆ°ä½

**æ–‡æ¡£éªŒæ”¶**:
- [ ] APIæ–‡æ¡£å®Œæ•´å‡†ç¡®
- [ ] ä½¿ç”¨æ‰‹å†Œæ¸…æ™°æ˜“æ‡‚
- [ ] éƒ¨ç½²æ–‡æ¡£å¯æ‰§è¡Œ

---

## 9. åç»­ä¼˜åŒ–è®¡åˆ’

### 9.1 çŸ­æœŸä¼˜åŒ–ï¼ˆä¸Šçº¿å1ä¸ªæœˆï¼‰

- [ ] æ ¹æ®å®é™…ä½¿ç”¨åé¦ˆä¼˜åŒ–äº¤äº’
- [ ] è¡¥å……é—æ¼çš„åŠŸèƒ½ç‚¹
- [ ] æ€§èƒ½è°ƒä¼˜
- [ ] ä¿®å¤å‘ç°çš„bug

### 9.2 ä¸­æœŸè§„åˆ’ï¼ˆ3ä¸ªæœˆï¼‰

- [ ] æ·»åŠ æ›´å¤šæ•°æ®åˆ†æç»´åº¦
- [ ] å®ç°å¯¼å‡ºåŠŸèƒ½ï¼ˆExcelã€PDFï¼‰
- [ ] å¢åŠ æ›´å¤šæ‰¹é‡æ“ä½œ
- [ ] ç§»åŠ¨ç«¯ç®¡ç†åå°

### 9.3 é•¿æœŸè§„åˆ’ï¼ˆ6ä¸ªæœˆ+ï¼‰

- [ ] æƒé™ç³»ç»Ÿç»†åŒ–ï¼ˆè§’è‰²+æƒé™ï¼‰
- [ ] å·¥ä½œæµå®¡æ‰¹ç³»ç»Ÿ
- [ ] å¤šç§Ÿæˆ·æ”¯æŒ
- [ ] å›½é™…åŒ–æ”¯æŒ

---

## 10. å›¢é˜Ÿåˆ†å·¥å»ºè®®

æ ¹æ®é¡¹ç›®è§„æ¨¡ï¼Œå»ºè®®åˆ†å·¥ï¼š

| è§’è‰² | èŒè´£ | å·¥ä½œé‡ |
|------|------|--------|
| åç«¯å¼€å‘1 | Phase 1åŸºç¡€è®¾æ–½ + Phase 2è·¯ç”±é‡æ„ | 2å‘¨ |
| åç«¯å¼€å‘2 | Phase 3ç®¡ç†æ¥å£å¼€å‘ | 1.5å‘¨ |
| å‰ç«¯å¼€å‘ | Phase 4å‰ç«¯å¯¹æ¥ | 1.5å‘¨ |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | Phase 4æµ‹è¯• + å…¨æµç¨‹è´¨é‡ä¿éšœ | æŒç»­ |
| é¡¹ç›®ç»ç† | æ•´ä½“åè°ƒ + æ–‡æ¡£æ•´ç† | æŒç»­ |

---

## 11. é™„å½•

### 11.1 ç›¸å…³æ–‡æ¡£

- [APIæ¶æ„è®¾è®¡æ–¹æ¡ˆ](./APIæ¶æ„è®¾è®¡æ–¹æ¡ˆ.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../database/æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
- [ç®¡ç†åå°README](../../admin/README.md)

### 11.2 å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# è¿è¡Œæµ‹è¯•
npm run test

# æ•°æ®åº“è¿ç§»
npm run migration:run

# æŸ¥çœ‹æ—¥å¿—
pm2 logs backend

# é‡å¯æœåŠ¡
pm2 restart backend
```

### 11.3 è”ç³»æ–¹å¼

- **æŠ€æœ¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **äº§å“ç»ç†**: [å¾…å¡«å†™]
- **é¡¹ç›®ç»ç†**: [å¾…å¡«å†™]

---

**æ–‡æ¡£ç¼–å†™**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**æœ€åæ›´æ–°**: 2024-01-20
