# 状态管理与配置

## 一、Vuex状态管理

### 目录结构
```
store/
├── index.js           # Store主入口
└── modules/           # 状态模块
    ├── index.js       # 模块集合
    ├── app.js         # 应用状态
    └── user.js        # 用户状态
```

---

## 二、Store模块详解

### 1. App模块 (store/modules/app.js)

#### State
```javascript
{
  themeBgColor: '#FFFFFF',      // 主题背景色
  darkMode: false,              // 是否暗色模式
  systemInfo: {},               // 系统信息
  networkType: 'unknown',       // 网络类型
  language: 'zh-CN'             // 语言设置
}
```

#### Getters
```javascript
{
  themeBgColor: state => state.themeBgColor,
  darkMode: state => state.darkMode,
  systemInfo: state => state.systemInfo,
  networkType: state => state.networkType,
  language: state => state.language
}
```

#### Mutations
```javascript
{
  SET_THEME_BG_COLOR(state, color),    // 设置主题背景色
  SET_DARK_MODE(state, isDark),        // 设置暗色模式
  SET_SYSTEM_INFO(state, info),        // 设置系统信息
  SET_NETWORK_TYPE(state, type),       // 设置网络类型
  SET_LANGUAGE(state, lang)            // 设置语言
}
```

#### Actions
```javascript
{
  // 初始化应用
  initApp({ commit }) {
    // 获取系统信息
    const systemInfo = uni.getSystemInfoSync()
    commit('SET_SYSTEM_INFO', systemInfo)
    
    // 获取网络类型
    uni.getNetworkType({
      success: (res) => {
        commit('SET_NETWORK_TYPE', res.networkType)
      }
    })
  },
  
  // 切换主题
  toggleTheme({ commit, state }) {
    const isDark = !state.darkMode
    commit('SET_DARK_MODE', isDark)
    commit('SET_THEME_BG_COLOR', isDark ? '#121212' : '#FFFFFF')
    uni.setStorageSync('darkMode', isDark)
  },
  
  // 切换语言
  changeLanguage({ commit }, lang) {
    commit('SET_LANGUAGE', lang)
    uni.setStorageSync('language', lang)
  }
}
```

---

### 2. User模块 (store/modules/user.js)

#### State
```javascript
{
  user: null,                    // 用户信息对象
  token: '',                     // JWT Token
  isLoggedIn: false,             // 登录状态
  creditBalance: 0,              // 点数余额
  permissions: [],               // 权限列表
  loginTime: null               // 登录时间
}
```

#### Getters
```javascript
{
  // 用户信息
  user: state => state.user,
  
  // Token
  token: state => state.token || state.user?.token,
  
  // 登录状态
  isLoggedIn: state => state.isLoggedIn && !!state.token,
  
  // 点数余额
  userCreditBalance: state => state.creditBalance || state.user?.creditBalance || 0,
  
  // 用户ID
  userId: state => state.user?.id || 0,
  
  // 用户昵称
  nickname: state => state.user?.nickname || '游客',
  
  // 用户头像
  avatar: state => state.user?.avatar || '/static/img/default-avatar.png',
  
  // 权限判断
  hasPermission: state => permission => {
    return state.permissions.includes(permission)
  }
}
```

#### Mutations
```javascript
{
  // 设置用户信息
  SET_USER(state, user) {
    state.user = user
    state.isLoggedIn = !!user
  },
  
  // 设置Token
  SET_TOKEN(state, token) {
    state.token = token
  },
  
  // 设置点数余额
  SET_CREDIT_BALANCE(state, balance) {
    state.creditBalance = balance
    if (state.user) {
      state.user.creditBalance = balance
    }
  },
  
  // 设置权限
  SET_PERMISSIONS(state, permissions) {
    state.permissions = permissions
  },
  
  // 更新用户信息
  UPDATE_USER_INFO(state, info) {
    if (state.user) {
      state.user = { ...state.user, ...info }
    }
  },
  
  // 清除用户信息
  CLEAR_USER(state) {
    state.user = null
    state.token = ''
    state.isLoggedIn = false
    state.creditBalance = 0
    state.permissions = []
  }
}
```

#### Actions
```javascript
{
  // 登录
  async login({ commit }, loginData) {
    try {
      const response = await minApi.wechatAuth(loginData)
      
      if (response.code === 200) {
        const { user, token } = response.data
        
        // 保存到Vuex
        commit('SET_USER', user)
        commit('SET_TOKEN', token)
        commit('SET_CREDIT_BALANCE', user.creditBalance || 0)
        
        // 保存到本地存储
        uni.setStorageSync('token', token)
        uni.setStorageSync('user', user)
        uni.setStorageSync('loginTime', new Date().toISOString())
        
        console.log('✅ 登录成功')
        return user
      } else {
        throw new Error(response.message || '登录失败')
      }
    } catch (error) {
      console.error('❌ 登录失败:', error)
      throw error
    }
  },
  
  // 退出登录
  logout({ commit }) {
    // 清除Vuex状态
    commit('CLEAR_USER')
    
    // 清除本地存储
    uni.removeStorageSync('token')
    uni.removeStorageSync('user')
    uni.removeStorageSync('loginTime')
    
    console.log('✅ 退出登录成功')
    
    // 跳转到登录页
    uni.reLaunch({ url: '/pages/login/login' })
  },
  
  // 获取点数余额
  async getCreditBalance({ commit }) {
    try {
      const response = await minApi.getCreditBalance()
      
      if (response.code === 200) {
        const balance = response.data.balance || 0
        commit('SET_CREDIT_BALANCE', balance)
        return balance
      }
      
      return 0
    } catch (error) {
      console.error('❌ 获取点数余额失败:', error)
      return 0
    }
  },
  
  // 刷新用户信息
  async refreshUserInfo({ commit }) {
    try {
      const response = await minApi.getUserProfile()
      
      if (response.code === 200) {
        commit('UPDATE_USER_INFO', response.data)
        commit('SET_CREDIT_BALANCE', response.data.creditBalance || 0)
        
        // 更新本地存储
        const user = uni.getStorageSync('user')
        uni.setStorageSync('user', { ...user, ...response.data })
        
        return response.data
      }
    } catch (error) {
      console.error('❌ 刷新用户信息失败:', error)
    }
  },
  
  // 更新点数余额（本地）
  updateCreditBalance({ commit }, amount) {
    const currentBalance = state.creditBalance
    const newBalance = currentBalance + amount
    commit('SET_CREDIT_BALANCE', newBalance)
  }
}
```

---

## 三、Store主入口 (store/index.js)

```javascript
import Vue from 'vue'
import Vuex from 'vuex'
import app from './modules/app'
import user from './modules/user'

Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    app,
    user
  },
  
  // 严格模式（开发环境）
  strict: process.env.NODE_ENV !== 'production'
})

export default store
```

---

## 四、配置文件

### 1. 应用配置 (config/index.js)

```javascript
/**
 * API配置
 */
const devApiAddress = 'http://192.168.1.118:3000'
const localhostApiAddress = 'http://localhost:8080'
const prodApiAddress = 'http://your-production-domain.com'

const ipAddress = devApiAddress

const getBaseUrl = () => {
  // #ifdef H5
  return '/api'
  // #endif
  // #ifndef H5
  return ipAddress + '/api'
  // #endif
}

export default {
  // API基础URL
  baseUrl: getBaseUrl(),
  
  // 文件访问地址
  fileAddr: `${ipAddress}/file/`,
  
  // 开发环境API地址
  devApiAddress: devApiAddress,
  
  // 生产环境API地址
  prodApiAddress: prodApiAddress,
  
  // 请求超时时间（毫秒）
  timeout: 60000,
  
  // 上传文件大小限制（MB）
  maxFileSize: 10,
  
  // 分页配置
  pagination: {
    pageSize: 20,
    pageSizeOptions: [10, 20, 50, 100]
  },
  
  // 音乐配置
  music: {
    // 音乐生成消耗点数
    generateCost: 30,
    // AI歌词生成消耗点数
    lyricsCost: 20,
    // 支持的音乐风格
    styles: [
      'pop', 'rock', 'folk', 'electronic', 
      'rnb', 'hiphop', 'classical', 'jazz',
      'country', 'ballad', 'edm', 'indie'
    ],
    // 支持的声音类型
    voices: ['male', 'female', 'neutral']
  },
  
  // 点数配置
  credit: {
    // 签到奖励
    checkinReward: 10,
    // 首次创作奖励
    firstCreationReward: 10,
    // 分享奖励
    shareReward: 5
  }
}
```

### 2. 页面配置 (pages.json)

**核心配置项**:
```json
{
  "pages": [ /* 页面路由配置 */ ],
  
  "tabBar": {
    "color": "#8a8a8a",
    "selectedColor": "#3B7EFF",
    "backgroundColor": "#121212",
    "borderStyle": "black",
    "list": [
      { /* TabBar项配置 */ }
    ]
  },
  
  "globalStyle": {
    "navigationBarTextStyle": "white",
    "navigationBarTitleText": "AI音乐创作助手",
    "navigationBarBackgroundColor": "#121212",
    "backgroundColor": "#121212"
  }
}
```

### 3. 应用配置 (manifest.json)

**核心配置项**:
```json
{
  "name": "EHS",
  "appid": "__UNI__1849516",
  "versionName": "2.0.4",
  "versionCode": 204,
  
  "mp-weixin": {
    "appid": "wxb331c8c2878d040c",
    "setting": {
      "urlCheck": false
    }
  },
  
  "h5": {
    "devServer": {
      "port": 9090,
      "proxy": { /* 代理配置 */ }
    }
  }
}
```

---

## 五、在组件中使用Store

### 1. 使用mapGetters
```vue
<template>
  <view>
    <text>用户昵称：{{ nickname }}</text>
    <text>点数余额：{{ userCreditBalance }}</text>
  </view>
</template>

<script>
import { mapGetters } from 'vuex'

export default {
  computed: {
    ...mapGetters(['nickname', 'userCreditBalance', 'isLoggedIn'])
  }
}
</script>
```

### 2. 使用mapActions
```vue
<script>
import { mapActions } from 'vuex'

export default {
  methods: {
    ...mapActions(['login', 'logout', 'getCreditBalance']),
    
    async handleLogin() {
      try {
        await this.login({ code: 'xxx' })
        uni.showToast({ title: '登录成功' })
      } catch (error) {
        uni.showToast({ title: '登录失败', icon: 'none' })
      }
    }
  }
}
</script>
```

### 3. 直接访问Store
```vue
<script>
export default {
  methods: {
    checkLogin() {
      const isLoggedIn = this.$store.getters.isLoggedIn
      if (!isLoggedIn) {
        uni.navigateTo({ url: '/pages/login/login' })
      }
    },
    
    async loadUserData() {
      const balance = await this.$store.dispatch('getCreditBalance')
      console.log('点数余额:', balance)
    }
  }
}
</script>
```

---

## 六、本地存储策略

### 存储的数据
```javascript
// 用户相关
'token'              // JWT Token
'user'               // 用户信息对象
'loginTime'          // 登录时间

// 应用相关
'darkMode'           // 暗色模式开关
'language'           // 语言设置

// 创作相关
'hasCreatedBefore'   // 是否创作过
'manual_draft'       // 自主创作草稿
'ai_draft'           // AI创作草稿

// 其他
'searchHistory'      // 搜索历史
'isAuthorized'       // 是否已授权
```

### 存储操作封装
```javascript
// 使用MinCache工具类
import MinCache from '@/utils/MinCache'

// 设置缓存（永久）
MinCache.set('key', value)

// 设置缓存（带过期时间，单位：秒）
MinCache.set('key', value, 3600)

// 获取缓存
const value = MinCache.get('key')

// 删除缓存
MinCache.remove('key')

// 清空所有缓存
MinCache.clear()
```

---

## 七、环境变量

### 开发环境
```javascript
process.env.NODE_ENV === 'development'
```

### 生产环境
```javascript
process.env.NODE_ENV === 'production'
```

### 平台判断
```javascript
// #ifdef H5
// H5平台特有代码
// #endif

// #ifdef MP-WEIXIN
// 微信小程序特有代码
// #endif

// #ifdef APP-PLUS
// App平台特有代码
// #endif
```

---

## 八、状态持久化

### 自动持久化
Store的某些状态会自动同步到本地存储：

1. **用户信息** (`user`)
   - 登录时自动保存
   - 退出时自动清除
   - 应用启动时自动恢复

2. **Token** (`token`)
   - 登录时自动保存
   - 每次API请求自动携带
   - 过期后自动清除

3. **主题设置** (`darkMode`)
   - 切换时自动保存
   - 应用启动时自动恢复

### 手动持久化
```javascript
// 保存到本地
uni.setStorageSync('key', value)

// 从本地读取
const value = uni.getStorageSync('key')

// 监听存储变化
uni.onStorageChange((res) => {
  console.log('存储变化:', res.key, res.newValue)
})
```

---

## 九、配置总结

### 关键配置项
- **API地址**: config/index.js
- **页面路由**: pages.json
- **应用信息**: manifest.json
- **主题配置**: globalStyle
- **状态管理**: store/modules/*

### 修改配置后的操作
1. 修改API地址 → 重启开发服务器
2. 修改pages.json → 保存后自动生效
3. 修改manifest.json → 需要重新编译
4. 修改Store → 热更新生效
